<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>æ°´ä¹‹å®šç«‹ï½œæŒ‡å°–ç©©å‹¢</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Noto Sans TC"', 'sans-serif'],
            },
            colors: {
              wood: {
                50: '#fdf8f6',
                100: '#f2e8e5',
                200: '#eaddd7',
                300: '#e0cec7',
                400: '#d2bab0',
                500: '#a18e87',
                600: '#8a7a74',
                700: '#72635e',
                800: '#5e514d',
                900: '#4a403d',
              },
              water: {
                light: '#e0f2fe', // Sky 100
                main: '#38bdf8',  // Sky 400 - Main Highlight
                dark: '#0284c7',  // Sky 600
                accent: '#0ea5e9',
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        font-family: 'Noto Sans TC', sans-serif;
        background-color: #fdf8f6;
        overflow: hidden; /* Prevent scrolling during game */
        user-select: none;
        -webkit-user-select: none;
        touch-action: none;
      }
      .wood-texture {
        background-color: #fcf6f0;
        background-image: radial-gradient(#d4c5b8 0.5px, transparent 0.5px), radial-gradient(#d4c5b8 0.5px, #fcf6f0 0.5px);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
      }
      .fade-in { animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      /* Shiny Water Drop Effect */
      .water-drop {
        background: radial-gradient(circle at 35% 25%, white 2%, #38bdf8 15%, #0284c7 80%);
        box-shadow: inset -10px -10px 20px rgba(0,0,0,0.1), 0 10px 20px rgba(0,0,0,0.15);
      }
      .hidden-force {
        display: none !important;
      }
    </style>
</head>
<body class="wood-texture text-wood-900 min-h-screen tracking-wide">
  <div id="app" class="relative min-h-screen">

    <!-- Start Screen -->
    <div id="screen-start" class="min-h-screen flex flex-col items-center justify-center p-4">
      <div class="max-w-md w-full bg-white/90 backdrop-blur-sm p-8 rounded-2xl shadow-xl border-2 border-wood-300 text-center fade-in">
        <div class="mb-6">
          <span class="text-6xl">ğŸ’§</span>
        </div>

        <h1 class="text-3xl md:text-4xl font-black text-wood-900 mb-6 tracking-widest">
          æ°´ä¹‹å®šç«‹ï½œæŒ‡å°–ç©©å‹¢
        </h1>

        <!-- Subtitle + Rules -->
        <div class="bg-wood-50 p-6 rounded-xl border border-wood-300 text-left mb-8">
          <p class="text-wood-700 mb-4 font-bold tracking-wider text-lg">
            è…ç‚ºå…ˆå¤©ä¹‹æœ¬ï¼Œè…æ°£å……ç›ˆå‰‡ç©©å¦‚éœæ°´ã€‚
          </p>
          <p class="text-base text-wood-600 mb-6 leading-relaxed font-medium tracking-wide">
            æ°´è¡Œå°æ‡‰è‡Ÿè…‘ç‚ºè…èˆ‡è†€èƒ±ï¼Œèˆ‡éª¨éª¼ã€å¹³è¡¡èˆ‡ç©©å®šæœ‰é—œã€‚
          </p>

          <h2 class="text-xl font-bold text-wood-800 mb-3 border-b border-wood-300 pb-2 flex items-center gap-2 tracking-wider">
            <span>ğŸ“œ</span> éŠæˆ²è¦å‰‡
          </h2>
          <ul class="space-y-3 text-wood-800 leading-relaxed text-base font-medium tracking-wide">
            <li class="flex items-start gap-2">
              <span class="font-bold text-water-main">â‘ </span>
              <span>é»æŒ‰å·¦å³å´ï¼Œä¿æŒæ°´æ»´çš„é‡å¿ƒ</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="font-bold text-water-main">â‘¡</span>
              <span>é•·æŒ‰çŸ­æŒ‰å¯èª¿æ•´èª¿æ•´çš„åŠ›é“</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="font-bold text-water-main">â‘¢</span>
              <span>æ ¹æ“šç¶­æŒå¹³è¡¡çš„ç§’æ•¸è¨ˆåˆ†</span>
            </li>
          </ul>
        </div>

        <button
          onclick="game.startGame()"
          class="w-full font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 bg-water-main hover:bg-water-accent text-white shadow-wood-200 px-8 py-3 text-2xl tracking-widest"
        >
          é–‹å§‹éŠæˆ²
        </button>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="screen-game" class="hidden-force min-h-screen flex flex-col">
      <!-- Top bar -->
      <div class="h-16 bg-white/95 backdrop-blur border-b border-wood-300 shadow-sm px-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-2xl">ğŸ’§</span>
          <span class="hidden sm:block text-wood-800 font-bold tracking-wide">ç¶­æŒå¹³è¡¡ä¸­...</span>
        </div>
        <div class="text-wood-700 font-mono text-lg tracking-widest">
          <span>æ™‚é–“ï¼š</span>
          <span id="time-display">0</span><span>s</span>
        </div>
        <div>
          <button
            onclick="game.restart()"
            class="font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 bg-water-main hover:bg-water-accent text-white px-3 py-1 text-base tracking-wide"
          >
            é‡ä¾†
          </button>
        </div>
      </div>

      <!-- Main Area -->
      <div
        id="game-area"
        class="flex-1 flex flex-col items-center justify-center p-4"
      >
        <!-- Hint -->
        <div class="mb-6 text-center">
          <p class="text-wood-700 font-bold tracking-wider text-lg mb-2">
            è¼•é»å·¦å³å´ï¼Œè®“æ°´æ»´ç©©ç©©ç«™ç«‹
          </p>
          <p class="text-wood-500 text-sm tracking-wide">
            é•·æŒ‰åŠ›é“è¼ƒå¤§ï¼ŒçŸ­æŒ‰å‰‡ç´°ç·»å¾®èª¿
          </p>
        </div>

        <!-- Drop + Baseline -->
        <div class="relative w-full max-w-xs h-80 flex items-center justify-center">
          <!-- Baseline -->
          <div class="absolute bottom-16 left-1/2 -translate-x-1/2 w-40 h-0.5 bg-wood-300 rounded-full"></div>

          <!-- Water Drop Wrapper -->
          <div
            id="drop-wrapper"
            class="absolute bottom-24 left-1/2 -translate-x-1/2 origin-bottom transition-transform duration-75"
          >
            <div class="relative w-20 h-28 flex items-center justify-center">
              <!-- Drop Shape -->
              <div
                id="water-drop"
                class="water-drop w-16 h-24 rounded-full relative"
                style="clip-path: path('M 50 0 C 80 40 100 70 80 100 C 60 120 40 120 20 100 C 0 70 20 40 50 0 Z');"
              ></div>
            </div>
          </div>
        </div>

        <!-- Timer in center (big) -->
        <div class="mt-8 flex flex-col items-center justify-center">
          <div class="text-wood-600 font-bold text-xl mb-2 tracking-wider">ç¶­æŒæ™‚é–“</div>
          <div
            id="time-display-big"
            class="font-mono text-6xl md:text-7xl font-black text-wood-800 drop-shadow-sm leading-none"
          >
            0
          </div>
        </div>
      </div>
    </div>

    <!-- Result Modal -->
    <div
      id="modal-result"
      class="hidden-force fixed inset-0 z-50 flex items-center justify-center p-4 bg-wood-900/60 backdrop-blur-sm fade-in"
    >
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden p-6 text-center relative border-2 border-wood-300">
        <!-- Close X -->
        <button
          onclick="ui.closeResult()"
          class="absolute top-4 right-4 text-wood-400 hover:text-wood-700 transition-colors p-2 rounded-full hover:bg-wood-100"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <div class="text-7xl mb-4">ğŸ’§</div>

        <div class="mb-4">
          <p class="text-wood-600 mb-1 font-bold tracking-wider text-lg">
            ç¶­æŒæ™‚é–“
          </p>
          <p class="text-5xl font-black text-wood-900 tracking-wide mb-2">
            <span id="res-time">0</span> s
          </p>
        </div>

        <div class="bg-wood-50 p-4 rounded-xl border-2 border-wood-200 mb-4">
          <h3
            id="res-msg"
            class="text-2xl font-bold text-water-dark mb-2 tracking-wider"
          >
          </h3>
          <p
            id="res-submsg"
            class="text-wood-700 text-base mb-3 font-medium leading-relaxed tracking-wide"
          >
          </p>
          <div
            class="flex justify-center items-center gap-1 text-water-dark text-base font-bold bg-white py-2 rounded-lg border border-wood-200 shadow-sm"
          >
            <span>å¾—åˆ†ï¼š</span>
            <span id="res-score" class="text-3xl text-wood-800">0</span>
            <span>åˆ†</span>
          </div>
        </div>

        <!-- Scoring Table -->
        <div class="text-left mb-6">
          <h4 class="text-base font-bold text-wood-500 mb-2 border-b border-wood-200 pb-1 tracking-wider">
            ğŸ… è¨ˆåˆ†æ–¹å¼
          </h4>
          <div class="space-y-2 text-sm text-wood-700 tracking-wide">
            <div class="flex justify-between items-center gap-2">
              <span class="font-bold text-water-dark whitespace-nowrap">20â€“30 ç§’</span>
              <span class="font-bold text-wood-700">3åˆ†</span>
              <span class="text-right flex-1">è…æ°£å……ç›ˆï¼Œç©©è‹¥éœæ°´</span>
            </div>
            <div class="flex justify-between items-center gap-2">
              <span class="font-bold text-water-dark whitespace-nowrap">15â€“19 ç§’</span>
              <span class="font-bold text-wood-700">2åˆ†</span>
              <span class="text-right flex-1">è…æ°£ä¸éŒ¯ï¼Œéœä¸­å¸¶ç©©</span>
            </div>
            <div class="flex justify-between items-center gap-2">
              <span class="font-bold text-water-dark whitespace-nowrap">0â€“14 ç§’</span>
              <span class="font-bold text-wood-700">1åˆ†</span>
              <span class="text-right flex-1">è…æ°£åå¼±ï¼Œéœ€å¤šèª¿é¤Š</span>
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-3">
          <button
            onclick="game.restart()"
            class="w-full font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 bg-water-main hover:bg-water-accent text-white shadow-wood-200 px-6 py-2 text-lg tracking-widest border border-transparent"
          >
            å†ä¾†ä¸€æ¬¡
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STATE = {
      status: 'START', // START, PLAYING, FINISHED
      startTime: 0,
      elapsed: 0,
      tiltAngle: 0,       // è§’åº¦ï¼ˆåº¦æ•¸ï¼‰
      tiltVelocity: 0,    // è§’é€Ÿåº¦ï¼ˆåº¦/ç§’ï¼‰
      animationId: null,
      pointerActive: false,
      pointerDirection: 0, // -1 å·¦, +1 å³
      lastFrameTime: 0,
      lastResult: null,
    };

    const ui = {
      els: {
        screenStart: document.getElementById('screen-start'),
        screenGame: document.getElementById('screen-game'),
        timeDisplay: document.getElementById('time-display'),
        timeDisplayBig: document.getElementById('time-display-big'),
        dropWrapper: document.getElementById('drop-wrapper'),
        modalResult: document.getElementById('modal-result'),
        resTime: document.getElementById('res-time'),
        resMsg: document.getElementById('res-msg'),
        resSubMsg: document.getElementById('res-submsg'),
        resScore: document.getElementById('res-score'),
        gameArea: document.getElementById('game-area'),
      },

      showStart() {
        this.els.screenStart.classList.remove('hidden-force');
        this.els.screenGame.classList.add('hidden-force');
        this.hideResult();
      },

      showGame() {
        this.els.screenStart.classList.add('hidden-force');
        this.els.screenGame.classList.remove('hidden-force');
      },

      updateTimeDisplay(sec) {
        const s = Math.floor(sec);
        this.els.timeDisplay.textContent = s;
        this.els.timeDisplayBig.textContent = s;
      },

      updateDropAngle(angle) {
        this.els.dropWrapper.style.transform =
          `translateX(-50%) translateY(0) rotate(${angle}deg)`;
      },

      showResult(data) {
        if (!data) return;
        this.els.resTime.textContent = Math.floor(data.time);
        this.els.resScore.textContent = data.score;
        this.els.resMsg.textContent = data.message;
        this.els.resSubMsg.textContent = data.subMessage;
        this.els.modalResult.classList.remove('hidden-force');
      },

      hideResult() {
        this.els.modalResult.classList.add('hidden-force');
      },

      closeResult() {
        this.hideResult();
      },
    };

    const game = {
      init() {
        STATE.status = 'START';
        STATE.tiltAngle = 0;
        STATE.tiltVelocity = 0;
        STATE.elapsed = 0;
        STATE.pointerActive = false;
        STATE.pointerDirection = 0;
        if (STATE.animationId) cancelAnimationFrame(STATE.animationId);
        ui.updateTimeDisplay(0);
        ui.updateDropAngle(0);
        ui.showStart();
      },

      startGame() {
        STATE.status = 'PLAYING';
        STATE.startTime = performance.now();
        STATE.lastFrameTime = STATE.startTime;
        STATE.elapsed = 0;
        STATE.tiltAngle = 0;     // ä¸€é–‹å§‹å®Œå…¨å‚ç›´
        STATE.tiltVelocity = 0;  // æ²’æœ‰åˆå§‹é€Ÿåº¦
        STATE.pointerActive = false;
        STATE.pointerDirection = 0;
        ui.showGame();
        ui.updateTimeDisplay(0);
        ui.updateDropAngle(0);
        this.bindInput();
        this.loop();
      },

      bindInput() {
        const area = ui.els.gameArea;

        const onPointerDown = (e) => {
          if (STATE.status !== 'PLAYING') return;
          e.preventDefault();
          const x = e.clientX || (e.touches && e.touches[0]?.clientX);
          const mid = window.innerWidth / 2;
          STATE.pointerActive = true;
          STATE.pointerDirection = x < mid ? -1 : 1;
        };

        const onPointerUp = (e) => {
          e && e.preventDefault();
          STATE.pointerActive = false;
          STATE.pointerDirection = 0;
        };

        area.onpointerdown = onPointerDown;
        area.onpointerup = onPointerUp;
        area.onpointercancel = onPointerUp;
        area.onpointerleave = () => {
          STATE.pointerActive = false;
          STATE.pointerDirection = 0;
        };
      },

      loop() {
        if (STATE.status !== 'PLAYING') return;

        const now = performance.now();
        const dt = (now - STATE.lastFrameTime) / 1000; // ç§’
        STATE.lastFrameTime = now;

        // æ›´æ–°ç¶“éæ™‚é–“
        STATE.elapsed = (now - STATE.startTime) / 1000;
        const t = STATE.elapsed;
        ui.updateTimeDisplay(t);

        // ---- é›£åº¦æ›²ç·šèˆ‡ç‰©ç†æ¨¡æ“¬ ----

        let angle = STATE.tiltAngle;
        let vel = STATE.tiltVelocity;

        // åŸºç¤é˜»å°¼ï¼Œé¿å…é€Ÿåº¦å¤±æ§
        const damping = 0.985;
        vel *= damping;

        // è‡ªç„¶æ™ƒå‹• (å¾®å°å™ªéŸ³ + éš¨æ™‚é–“å¢åŠ çš„é›£åº¦)
        // å‰ 5 ç§’éå¸¸ç©©å®šï¼Œä¹‹å¾Œæ…¢æ…¢è®Šå¤§
        let difficultyFactor = 1;
        if (t > 5) {
          difficultyFactor = 1 + (t - 5) * 0.06; // æ¯ç§’æ…¢æ…¢å¢åŠ 
          if (difficultyFactor > 2.5) difficultyFactor = 2.5; // ä¸Šé™
        }

        // åŸºç¤éš¨æ©Ÿæ¼‚ç§»ï¼ˆè‡ªç„¶æ™ƒå‹•ï¼‰
        const baseDriftStrength = (t < 5 ? 2 : 5) * difficultyFactor; // åº¦/ç§’Â²
        const noise = (Math.random() * 2 - 1); // -1 ~ 1
        vel += noise * baseDriftStrength * dt;

        // ç©å®¶æ§åˆ¶åŠ›é“
        if (STATE.pointerActive && STATE.pointerDirection !== 0) {
          // åŸºç¤æ§åˆ¶åŠ›é“ï¼ˆåº¦/ç§’Â²ï¼‰
          const controlBase = 50;
          // éš¨è‘—æ™‚é–“è®Šé•·å¯ç¨å¾®æ”¾å¤§ä¸€é»æ§åˆ¶åŠ›
          const controlFactor = 1 + Math.min(t / 20, 0.5); // æœ€å¤š+50%
          const control = controlBase * controlFactor;
          vel += STATE.pointerDirection * control * dt * -1;
          // * -1 æ˜¯è®“é»å·¦é‚Šæ™‚ï¼Œè¦–è¦ºä¸Šæ°´æ»´å¾€å·¦ä¿®æ­£
        }

        // æ›´æ–°è§’åº¦
        angle += vel * dt;

        // å‰ 3 ç§’ä¿è­·æœŸï¼šé™åˆ¶æœ€å¤§è§’åº¦ï¼Œä¸æœƒå€’
        const protectTime = 3;
        const protectAngle = 10; // åº¦
        const criticalAngle = 28; // è¶…éå°±å€’ä¸‹ï¼ˆä¿è­·æœŸå¾Œï¼‰

        if (t < protectTime) {
          if (angle > protectAngle) angle = protectAngle;
          if (angle < -protectAngle) angle = -protectAngle;
        }

        // ç¡¬æ€§é™åˆ¶ï¼Œé¿å…æ•¸å€¼çˆ†ç‚¸
        if (angle > 60) angle = 60;
        if (angle < -60) angle = -60;

        STATE.tiltAngle = angle;
        STATE.tiltVelocity = vel;
        ui.updateDropAngle(angle);

        // åˆ¤å®šéŠæˆ²çµæŸæ¢ä»¶
        if (t >= 30) {
          // æ’æ»¿ 30 ç§’ï¼Œè‡ªå‹•çµæŸ
          this.finish(t);
          return;
        }

        if (t >= protectTime && Math.abs(angle) >= criticalAngle) {
          // è¶…éè‡¨ç•Œè§’åº¦å¾Œå€’ä¸‹
          this.finish(t);
          return;
        }

        STATE.animationId = requestAnimationFrame(() => this.loop());
      },

      finish(timeSec) {
        STATE.status = 'FINISHED';
        if (STATE.animationId) cancelAnimationFrame(STATE.animationId);

        const finalTime = Math.floor(timeSec);
        const result = this.calculateResult(finalTime);
        STATE.lastResult = result;
        ui.showResult(result);
      },

      calculateResult(sec) {
        let score = 1;
        let message = '';
        let subMessage = '';

        if (sec >= 20) {
          score = 3;
          message = 'è…æ°£å……ç›ˆï¼Œç©©è‹¥éœæ°´';
          subMessage = 'ä½ çš„æ²‰ç©©èˆ‡å°ˆæ³¨ï¼Œè®“å¹³è¡¡åƒæ°´é¢å¾®å…‰ä¸€æ¨£å®‰ç„¶ä¸å‹•ã€‚';
        } else if (sec >= 15) {
          score = 2;
          message = 'è…æ°£ä¸éŒ¯ï¼Œéœä¸­å¸¶ç©©';
          subMessage = 'å·²ç¶“æ‰¾åˆ°è‡ªå·±çš„ç¯€å¥ï¼Œå†å¤šä¸€é»è€å¿ƒï¼Œæœƒè¶Šç«™è¶Šç©©ã€‚';
        } else {
          score = 1;
          message = 'è…æ°£åå¼±ï¼Œéœ€å¤šèª¿é¤Š';
          subMessage = 'åˆ¥æ€¥è‘—å¦å®šè‡ªå·±ï¼Œå¾èª¿æ•´å‘¼å¸èˆ‡å°ˆæ³¨é–‹å§‹ï¼Œä¸‹ä¸€æ¬¡æœƒæ›´å¥½ã€‚';
        }

        return {
          time: sec,
          score,
          message,
          subMessage,
        };
      },

      restart() {
        this.init();
      },
    };

    // expose for buttons
    window.game = game;
    window.ui = ui;

    // init on load
    game.init();
  </script>
</body>
</html>
